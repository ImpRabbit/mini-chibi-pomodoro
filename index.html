<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒŸãƒ‹è‚²æˆãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      background: #050509;
      color: #f9f9ff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #333;
      font-size: 1rem;
    }

    header span {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    main {
      flex: 1;
      padding: 1rem;
    }

    .page {
      display: none;
    }
    .page.active {
      display: block;
    }

    .card {
      border-radius: 1rem;
      padding: 1rem;
      background: radial-gradient(circle at top, #202040, #050509);
      box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.5);
      margin-bottom: 1rem;
    }

    .title {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 0.9rem 1rem;
      margin: 0.4rem 0;
      border-radius: 999px;
      border: none;
      background: #865bff;
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
    }

    .btn.sub {
      background: #26263a;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    footer {
      border-top: 1px solid #333;
      padding: 0.5rem 0.75rem;
      display: flex;
      gap: 0.5rem;
      position: sticky;
      bottom: 0;
      background: rgba(5,5,9,0.95);
      backdrop-filter: blur(12px);
    }

    .nav-btn {
      flex: 1;
      font-size: 0.8rem;
      border-radius: 999px;
      border: none;
      padding: 0.4rem 0.2rem;
      background: #181820;
      color: #f0f0ff;
      cursor: pointer;
    }

    .nav-btn.active {
      background: #865bff;
      color: #fff;
      font-weight: 600;
    }

    .job-list-title {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      opacity: 0.9;
    }

    .helper-title {
      font-size: 0.9rem;
      margin-top: 1rem;
      margin-bottom: 0.3rem;
      opacity: 0.9;
    }

    .helper-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    .chip {
      border-radius: 999px;
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      border: 1px solid #444;
      background: #181820;
      color: #f5f5ff;
      cursor: pointer;
    }

    .chip.active {
      border-color: #c9a6ff;
      background: #865bff;
      color: #fff;
      font-weight: 600;
    }

    .mini-list {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-top: 0.3rem;
    }

    .mini-list div {
      margin-bottom: 0.2rem;
    }

    .collection-item {
      margin-bottom: 0.4rem;
      font-size: 0.85rem;
    }

    .collection-item span.name {
      font-weight: 600;
    }

    .collection-item span.state {
      opacity: 0.8;
      font-size: 0.78rem;
      margin-left: 0.4rem;
    }

    .history-entry {
      margin-bottom: 0.4rem;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* é€²æ—ãƒãƒ¼ */
    .progress-bar {
      width: 100%;
      height: 0.5rem;
      background: #333;
      border-radius: 0.25rem;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #865bff;
      transition: width 1s linear;
    }
  </style>
</head>
<body>
  <header>
    ãƒŸãƒ‹è‚²æˆãƒãƒ¢ãƒ‰ãƒ¼ãƒ­<br>
    <span>ã‹ã‚ã•ã¾ã¨ãƒŸãƒ‹ã®ãŠã—ã”ã¨ã‚¿ã‚¤ãƒ </span>
  </header>

  <main>
    <!-- ğŸ  ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ -->
    <section class="page active" data-page="home">
      <div class="card">
        <div class="title">ãƒªãƒ¼ãƒ€ãƒ¼ãƒŸãƒ‹ã®åŸ·å‹™å®¤</div>
        <div class="subtitle" id="leaderMessage">
          ã€Œã‹ã‚ã•ã¾ã€ä»Šæ—¥ã¯ã„ãã¤ãŠã—ã”ã¨ã™ã‚‹ï¼Ÿã€
        </div>

        <div class="status" id="jobStatus">
          ä»Šã®ä½œæ¥­ï¼šãªã—
        </div>
        <div class="status" id="helperStatus">
          ä»Šå›ã®æ‹…å½“ï¼šãªã—
        </div>
        <div class="status" id="timerStatus">
          ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ä¸­ã€‚å·¥æˆ¿ã§ãŠã—ã”ã¨ã‚’é¸ã¶ã¨å§‹ã¾ã‚‹ã‚ˆã€‚
        </div>

        <!-- é€²æ—ãƒãƒ¼ -->
        <div class="progress-bar" id="progressBar" style="display:none;">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status" id="phaseExtraStatus">
        </div>

        <button class="btn sub" id="cancelJobBtn" disabled aria-label="ä»Šã®ãŠã—ã”ã¨ã¾ãŸã¯ä¼‘æ†©ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«">
          â–  ä»Šã®ãŠã—ã”ã¨ï¼ä¼‘æ†©ã‚’ã‚„ã‚ã‚‹
        </button>

        <div class="status">
          å·¥æˆ¿ãƒ»ç ”ç©¶æ‰€ãƒ»è¨˜éŒ²å®¤ã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã„ã¤ã§ã‚‚è¡Œã‘ã‚‹ã‚ˆã€‚<br>
          ãƒšãƒ¼ã‚¸é·ç§»ãªã—ã§åˆ‡ã‚Šæ›¿ãˆã‚‹ã‹ã‚‰ã€ã‚¿ã‚¤ãƒãƒ¼ã¯æ­¢ã¾ã‚‰ãªã„äºˆå®šã ã‚ˆã€‚
        </div>
      </div>

      <div class="card">
        <div class="title">ãƒŸãƒ‹ãŸã¡ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
        <div class="subtitle">
          ã€Œã¼ããŒãƒªãƒ¼ãƒ€ãƒ¼ãƒŸãƒ‹ã€‚ãŠã¡ã³ãŸã¡ã®ã“ã¨ã¯ã€ã‹ã‚ã•ã¾ã«ã‚‚è¦šãˆã¦ãŠã„ã¦ã»ã—ã„ãªã€‚ã€
        </div>
        <div class="mini-list">
          <div>ãƒ»ãƒªãƒ¼ãƒ€ãƒ¼ãƒŸãƒ‹ï¼šã‹ã‚ã•ã¾æ‹…å½“ã€‚å…¨ä½“ã®ã¾ã¨ã‚å½¹ã€‚</div>
          <div>ãƒ»ã‚µãƒœã‚ŠãŠã¡ã³ï¼šã™ãä¼‘ã¿ãŸãŒã‚‹ã‘ã©ã€æ†ã‚ãªã„å­ã€‚</div>
          <div>ãƒ»ã‚€ã¦ã£ã½ã†ãŠã¡ã³ï¼šä½•ã‚‚è€ƒãˆãšã«çªæ’ƒã™ã‚‹å…ƒæ°—ãªå­ã€‚</div>
          <div>ãƒ»ã‚‚ã˜ã‚‚ã˜ãŠã¡ã³ï¼šã„ã¤ã‚‚æ¥ãšã‹ã—ãã†ã ã‘ã©ã€ä»•äº‹ã¯ã¦ã„ã­ã„ã€‚</div>
        </div>
      </div>
    </section>

    <!-- ğŸ§ª å·¥æˆ¿ãƒšãƒ¼ã‚¸ -->
    <section class="page" data-page="factory">
      <div class="card">
        <div class="title">å·¥æˆ¿</div>
        <div class="subtitle">
          ã€Œã“ã“ã‹ã‚‰ã€ã‹ã‚ã•ã¾ã¨ãƒŸãƒ‹ã®ãŠã—ã”ã¨ã‚¿ã‚¤ãƒ ã‚’æ±ºã‚ã‚ˆã†ã€‚ã€
        </div>

        <div class="job-list-title">ãŠã—ã”ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒãƒ¢ãƒ‰ãƒ¼ãƒ­é€£å‹•ï¼‰</div>

        <button class="btn job-btn" data-job-id="standard" data-minutes="25" data-label="æ¨™æº–ãŠã—ã”ã¨ï¼ˆ25åˆ†ï¼‰" aria-label="æ¨™æº–ãŠã—ã”ã¨ï¼ˆ25åˆ†ï¼‰ã‚’é–‹å§‹">
          ğŸ… æ¨™æº–ãŠã—ã”ã¨ï¼ˆ25åˆ†ï¼‰
        </button>
        <button class="btn job-btn" data-job-id="focus" data-minutes="50" data-label="ãŒã£ã¤ã‚Šé›†ä¸­ï¼ˆ50åˆ†ï¼‰" aria-label="ãŒã£ã¤ã‚Šé›†ä¸­ï¼ˆ50åˆ†ï¼‰ã‚’é–‹å§‹">
          ğŸ’ª ãŒã£ã¤ã‚Šé›†ä¸­ï¼ˆ50åˆ†ï¼‰
        </button>
        <button class="btn job-btn" data-job-id="short" data-minutes="15" data-label="ãŠãŸã‚ã—çŸ­æ™‚é–“ï¼ˆ15åˆ†ï¼‰" aria-label="ãŠãŸã‚ã—çŸ­æ™‚é–“ï¼ˆ15åˆ†ï¼‰ã‚’é–‹å§‹">
          ğŸ¾ ãŠãŸã‚ã—çŸ­æ™‚é–“ï¼ˆ15åˆ†ï¼‰
        </button>

        <div class="helper-title">ä»Šå›ä¸€ç·’ã«è¡ŒããŠã¡ã³</div>
        <div class="helper-row">
          <button class="chip helper-btn active" data-helper-id="auto" aria-label="ãŠã¾ã‹ã›ç·¨æˆã‚’é¸æŠ">
            ãŠã¾ã‹ã›
          </button>
          <button class="chip helper-btn" data-helper-id="lazy" aria-label="ã‚µãƒœã‚ŠãŠã¡ã³ã‚’é¸æŠ">
            ã‚µãƒœã‚ŠãŠã¡ã³
          </button>
          <button class="chip helper-btn" data-helper-id="wild" aria-label="ã‚€ã¦ã£ã½ã†ãŠã¡ã³ã‚’é¸æŠ">
            ã‚€ã¦ã£ã½ã†ãŠã¡ã³
          </button>
          <button class="chip helper-btn" data-helper-id="shy" aria-label="ã‚‚ã˜ã‚‚ã˜ãŠã¡ã³ã‚’é¸æŠ">
            ã‚‚ã˜ã‚‚ã˜ãŠã¡ã³
          </button>
        </div>

        <div class="status" id="factoryStatus">
          ä¸€ç·’ã«è¡ŒããŠã¡ã³ã‚’é¸ã‚“ã§ã‹ã‚‰ã€ãŠã—ã”ã¨ã‚’æŠ¼ã—ã¦ã­ã€‚<br>
          ä½•ã‚‚é¸ã°ãªã„å ´åˆã¯ã€ŒãŠã¾ã‹ã›ã€ã«ãªã‚‹ã‚ˆã€‚
        </div>
      </div>
    </section>

    <!-- ğŸ”¬ ç ”ç©¶æ‰€ãƒšãƒ¼ã‚¸ï¼ˆv1å®Ÿè£…ï¼‰ -->
    <section class="page" data-page="lab">
      <div class="card">
        <div class="title">ç ”ç©¶æ‰€</div>
        <div class="subtitle" id="labIntro">
          ã€Œå±ãªã„å®Ÿé¨“ã¯ã€ã‹ã‚ã•ã¾ãŒè¦‹ã¦ã‚‹ã¨ãã ã‘ã«ã—ã‚ˆã†ã­â€¦â€¦å¤šåˆ†ã€‚ã€
        </div>
        <div class="status" id="researchPointsStatus">
          ç¾åœ¨ã®ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆï¼š0 RP
        </div>
      </div>

      <div class="card">
        <div class="title">ç ”ç©¶ãƒ†ãƒ¼ãƒä¸€è¦§</div>
        <div class="status" id="researchList">
          ï¼ˆã¾ã ç ”ç©¶ãƒ†ãƒ¼ãƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã‚ˆï¼‰
        </div>
      </div>
    </section>

    <!-- ğŸ“š è¨˜éŒ²å®¤ãƒšãƒ¼ã‚¸ -->
    <section class="page" data-page="archive">
      <div class="card">
        <div class="title">è¨˜éŒ²å®¤ï¼šã‚¢ã‚¤ãƒ†ãƒ å›³é‘‘</div>
        <div class="subtitle">
          ã€Œã“ã“ã«ã€å·¥æˆ¿ã§ã§ããŸã‚‚ã®ã®è¨˜éŒ²ã‚’æ®‹ã—ã¦ã„ã“ã†ã€‚åŸ‹ã¾ã£ã¦ã„ãã¨ã€ã¡ã‚‡ã£ã¨å¬‰ã—ã„ã§ã—ã‚‡ï¼Ÿã€
        </div>
        <div class="status" id="collectionList">
          ï¼ˆã¾ã ä½•ã‚‚ä½œã‚‰ã‚Œã¦ã„ãªã„ã‚ˆï¼‰
        </div>
      </div>

      <div class="card">
        <div class="title">è¨˜éŒ²å®¤ï¼šãŠã—ã”ã¨ï¼†ä¼‘æ†©å±¥æ­´</div>
        <div class="subtitle">
          ã€Œã„ã¤ã€ã©ã®ãŠã—ã”ã¨ã‚’ã€èª°ã¨ã‚„ã£ãŸã‹ã€‚ä¼‘æ†©ä¸­ã®å‡ºæ¥äº‹ã‚‚å«ã‚ã¦ã€ã‹ã‚ã•ã¾ã®ãŒã‚“ã°ã‚Šã®è»Œè·¡ã ã‚ˆã€‚ã€
        </div>
        <div class="status" id="historyList">
          ï¼ˆã¾ã å±¥æ­´ã¯ãªã„ã‚ˆï¼‰
        </div>
      </div>
    </section>
  </main>

  <footer>
    <button class="nav-btn active" data-target="home" aria-label="ãƒ›ãƒ¼ãƒ ã¸ç§»å‹•">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <button class="nav-btn" data-target="factory" aria-label="å·¥æˆ¿ã¸ç§»å‹•">ğŸ§ª å·¥æˆ¿</button>
    <button class="nav-btn" data-target="lab" aria-label="ç ”ç©¶æ‰€ã¸ç§»å‹•">ğŸ”¬ ç ”ç©¶æ‰€</button>
    <button class="nav-btn" data-target="archive" aria-label="è¨˜éŒ²å®¤ã¸ç§»å‹•">ğŸ“š è¨˜éŒ²å®¤</button>
  </footer>

  <script>
    // ===== å®šæ•°ï¼ˆlocalStorageã‚­ãƒ¼ï¼‰ =====
    const STORAGE_KEYS = {
      discoveredItems: "miniPomodoro_discoveredItems",
      historyLogs: "miniPomodoro_historyLogs",
      researchPoints: "miniPomodoro_researchPoints",
      researchUnlocks: "miniPomodoro_researchUnlocks"
    };

    // ===== ğŸ”” ãƒ”ãƒ”ãƒ”ã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆiPhoneå¯¾å¿œï¼‰ =====
    let miniAudioCtx = null;

    function initAudioCtx() {
      if (!miniAudioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) {
          console.warn("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Audio APIã«å¯¾å¿œã—ã¦ãªã„ã‹ã‚‚ï¼");
          return;
        }
        miniAudioCtx = new AC();
      }
      if (miniAudioCtx.state === "suspended") {
        miniAudioCtx.resume();
      }
    }

    function playBeepPattern() {
      initAudioCtx();
      if (!miniAudioCtx) return;

      const ctx = miniAudioCtx;
      const baseTime = ctx.currentTime;
      const beepDuration = 0.10;
      const beepGap = 0.07;
      const groupGap = 0.35;

      let t = baseTime;

      for (let group = 0; group < 3; group++) {
        for (let i = 0; i < 3; i++) {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.type = "square";
          osc.frequency.value = 1100;

          osc.connect(gain);
          gain.connect(ctx.destination);

          gain.gain.setValueAtTime(0, t);
          gain.gain.linearRampToValueAtTime(0.35, t + 0.01);
          gain.gain.linearRampToValueAtTime(0, t + beepDuration);

          osc.start(t);
          osc.stop(t + beepDuration + 0.05);

          t += beepDuration + beepGap;
        }
        t += groupGap;
      }
    }

    // ===== ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ =====
    const pages = document.querySelectorAll(".page");
    const navButtons = document.querySelectorAll(".nav-btn");

    function showPage(name) {
      pages.forEach(p => {
        p.classList.toggle("active", p.dataset.page === name);
      });
      navButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.target === name);
      });

      if (name === "archive") {
        renderArchive();
      }
      if (name === "lab") {
        updateResearchUI();
      }
    }

    navButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        showPage(btn.dataset.target);
      });
    });

    // ===== ãƒŸãƒ‹ï¼ãŠã¡ã³è¨­å®š =====
    const HELPERS = {
      auto: {
        id: "auto",
        name: "ãŠã¾ã‹ã›ç·¨æˆ",
        shortName: "ãŠã¾ã‹ã›",
        startLine: "ã€Œèª°ãŒè¡Œãã‹ã¯ã€ã“ã£ã¡ã§ã†ã¾ãçµ„ã‚“ã§ãŠãã‚ˆã€‚ã‹ã‚ã•ã¾ã¯ä¼‘æ†©ã®æº–å‚™ã‚’ã—ã¦ã¦ã­ã€‚ã€",
        finishLine: "ã€ŒãŠã—ã”ã¨å®Œäº†ã€‚ãŠã¾ã‹ã›ãƒãƒ¼ãƒ ã€ã‚ˆãé ‘å¼µã£ã¦ãã‚ŒãŸã‚ˆã€‚ã€",
        successRate: 0.75,
        explosionRate: 0.10
      },
      lazy: {
        id: "lazy",
        name: "ã‚µãƒœã‚ŠãŠã¡ã³",
        shortName: "ã‚µãƒœã‚ŠãŠã¡ã³",
        startLine: "ã€Œâ€¦â€¦ã¡ã‚‡ã£ã¨å¿ƒé…ã ã‘ã©ã€ã‚µãƒœã‚ŠãŠã¡ã³ã«ã‚‚çµŒé¨“ã¯å¿…è¦ã ã­ã€‚ã€",
        finishLine: "ã€Œé€”ä¸­ã§ä½•å›ã‹ã•ã¼ã£ã¦ãŸã‘ã©â€¦â€¦ã¾ã‚ã€çµ‚ã‚ã£ãŸã‹ã‚‰è‰¯ã—ã¨ã—ã‚ˆã†ã‹ã€‚ã€",
        successRate: 0.80,
        explosionRate: 0.05
      },
      wild: {
        id: "wild",
        name: "ã‚€ã¦ã£ã½ã†ãŠã¡ã³",
        shortName: "ã‚€ã¦ã£ã½ã†ãŠã¡ã³",
        startLine: "ã€Œå±ãªã£ã‹ã—ã„ã‘ã©ã€å‹¢ã„ã¯ä¸€ç•ªãªã‚“ã ã€‚ã‹ã‚ã•ã¾ã€ã¡ã‚‡ã£ã¨ã ã‘è¦šæ‚Ÿã—ã¦ã¦ã­ã€‚ã€",
        finishLine: "ã€Œã‚®ãƒªã‚®ãƒªã ã£ãŸã‘ã©â€¦â€¦ãªã‚“ã¨ã‹ã‚„ã‚Šåˆ‡ã£ãŸã‚ˆã€‚ã•ã™ãŒã€ã‚€ã¦ã£ã½ã†ã€‚ã€",
        successRate: 0.70,
        explosionRate: 0.15
      },
      shy: {
        id: "shy",
        name: "ã‚‚ã˜ã‚‚ã˜ãŠã¡ã³",
        shortName: "ã‚‚ã˜ã‚‚ã˜ãŠã¡ã³",
        startLine: "ã€Œæ™‚é–“ã¯ã‹ã‹ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‘ã©ã€ãã®ã¶ã‚“ä¸å¯§ã«ã‚„ã£ã¦ãã‚Œã‚‹å­ã ã‚ˆã€‚ã€",
        finishLine: "ã€Œã¨ã¦ã‚‚ä¸å¯§ã«ä»•ä¸Šã’ã¦ãã‚Œã¦ãŸã‚ˆã€‚ã‹ã‚ã•ã¾ã‚‚ã€ã‚†ã£ãã‚Šæ·±å‘¼å¸ã—ã‚ˆã€‚ã€",
        successRate: 0.90,
        explosionRate: 0.03
      }
    };

    let currentHelperId = "auto";
    let currentHelperForJob = null;

    const helperButtons = document.querySelectorAll(".helper-btn");
    const factoryStatus = document.getElementById("factoryStatus");

    helperButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        helperButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentHelperId = btn.dataset.helperId;

        const helper = HELPERS[currentHelperId] || HELPERS.auto;
        factoryStatus.textContent = `ä»Šå›ã®ãŠã—ã”ã¨æ‹…å½“ï¼š${helper.name}ã€‚ã€Œ${helper.shortName}ã€ã¨ä¸€ç·’ã«ãŒã‚“ã°ã‚‹ã‚ˆã€‚`;
      });
    });

    function getCurrentHelper() {
      return HELPERS[currentHelperId] || HELPERS.auto;
    }

    // ===== ã‚¢ã‚¤ãƒ†ãƒ å®šç¾© & å·¥æˆ¿ãƒ¬ã‚·ãƒ” =====
    const ITEM_DEFS = {
      charm_bone: {
        id: "charm_bone",
        name: "éª¨ã®ãŠå®ˆã‚Šæ£’",
        desc: "ã‹ã‚ã•ã¾ã®æ¬ ç‰‡ã‹ã‚‰å‰Šã£ãŸã€å°ã•ãªãŠå®ˆã‚Šæ£’ã€‚ãŠã¡ã³ãŸã¡ã®å®ç‰©ã€‚",
        rarity: "common"
      },
      ribbon_mini: {
        id: "ribbon_mini",
        name: "ã¡ã³ã‚Šã¼ã‚“",
        desc: "ãŠã¡ã³ãŸã¡ã®é ­ã‚„éª¨ã«çµã¶ç”¨ã®å°ã•ãªã‚Šã¼ã‚“ã€‚",
        rarity: "common"
      },
      snack_crumb: {
        id: "snack_crumb",
        name: "ãŠã‚„ã¤ã®ã‹ã‘ã‚‰",
        desc: "ã‹ã‚ã•ã¾ã‹ã‚‰ã‚‚ã‚‰ã£ãŸãŠã‚„ã¤ãŒã¡ã‚‡ã£ã¨ã ã‘ä½™ã£ãŸã‚‚ã®ã€‚ãƒŸãƒ‹ãŸã¡ã®ä¼‘æ†©ç”¨ã€‚",
        rarity: "common"
      },
      barrier_seed: {
        id: "barrier_seed",
        name: "ãƒãƒªã‚¢ã®ãŸã­",
        desc: "ã‚‚ãµã‚‚ãµã‚·ãƒ¼ãƒ«ãƒ‰ã®ç´ ã«ãªã‚Šãã†ãªã€ä¸æ€è­°ãªçµæ™¶ã€‚",
        rarity: "uncommon"
      },
      light_fragment: {
        id: "light_fragment",
        name: "ã²ã‹ã‚Šã®ã‹ã‘ã‚‰",
        desc: "ãƒœãƒ«ãŠã˜ã®ã²ã‹ã‚Šã«ä¼¼ãŸã€ã»ã®ã‹ã«å…‰ã‚‹çµæ™¶ã€‚",
        rarity: "uncommon"
      },
      lab_note: {
        id: "lab_note",
        name: "ãƒŸãƒ‹ãŸã¡ã®ãƒ¡ãƒ¢",
        desc: "ãŠã¡ã³èªã§ã³ã£ã—ã‚Šæ›¸ã‹ã‚ŒãŸã€è¬ã®å®Ÿé¨“ãƒ¡ãƒ¢ã€‚èª­ã‚ã‚‹ã®ã¯ã‹ã‚ã•ã¾ã ã‘â€¦â€¦ã‹ã‚‚ï¼Ÿ",
        rarity: "rare"
      },
      safety_goggles: {
        id: "safety_goggles",
        name: "ãŠã¡ã³ç”¨å®‰å…¨ã‚´ãƒ¼ã‚°ãƒ«",
        desc: "ã‚µã‚¤ã‚ºã¯ã´ã£ãŸã‚Šã€‚ã§ã‚‚ã‹ã‘ã‚‹ã¨ã¡ã‚‡ã£ã¨ãƒ‰ãƒ¤é¡”ã«ãªã‚‹ã€‚",
        rarity: "uncommon"
      },
      burn_mark_sample: {
        id: "burn_mark_sample",
        name: "ã“ã’ã‚ã¨ã‚µãƒ³ãƒ—ãƒ«",
        desc: "å°çˆ†ç™ºã®è·¡ã‚’ãã£ã¨å‰Šã‚Šå–ã£ãŸã‚‚ã®ã€‚ãªãœã‹å¬‰ã—ãã†ã«é›†ã‚ã¦ã„ã‚‹ã€‚",
        rarity: "uncommon"
      },
      wanwan_fur: {
        id: "wanwan_fur",
        name: "ã‚ã‚“ã‚ã‚“ã®æ¯›",
        desc: "ãµã‚ãµã‚ã§ã‚ã£ãŸã‹ã„æ¯›æŸã€‚ãŠã¡ã³ãŸã¡ã®ãƒ™ãƒƒãƒ‰ç´ æå€™è£œã€‚",
        rarity: "uncommon"
      },
      secret_fragment: {
        id: "secret_fragment",
        name: "ã²ã¿ã¤ã®ã‹ã‘ã‚‰",
        desc: "æ­£ä½“ä¸æ˜ã®çµæ™¶ã€‚ãƒŸãƒ‹ãŸã¡ã‚‚ã€ã‹ã‚ã•ã¾ã‚‚ã¾ã ä½¿ã„é“ãŒã‚ã‹ã‚‰ãªã„ã€‚",
        rarity: "rare"
      }
    };

    const JOB_POOLS = {
      standard: ["charm_bone", "ribbon_mini", "snack_crumb", "safety_goggles"],
      focus: [
        "charm_bone",
        "ribbon_mini",
        "snack_crumb",
        "barrier_seed",
        "light_fragment",
        "lab_note",
        "safety_goggles",
        "burn_mark_sample"
      ],
      short: ["snack_crumb", "ribbon_mini"]
    };

    const RARE_ITEM_IDS = ["lab_note", "secret_fragment"];

    function pickRandomItemIdForJob(jobId) {
      const pool = JOB_POOLS[jobId] || JOB_POOLS.standard;
      const index = Math.floor(Math.random() * pool.length);
      return pool[index];
    }

    function pickRandomRareItemId() {
      if (RARE_ITEM_IDS.length === 0) return null;
      const index = Math.floor(Math.random() * RARE_ITEM_IDS.length);
      return RARE_ITEM_IDS[index];
    }

    function getExplosionRareChance(jobId, helperId) {
      let chance = 0;
      if (jobId === "focus") chance += 0.20;
      if (jobId === "standard") chance += 0.05;
      if (helperId === "wild") chance += 0.20;
      if (helperId === "lazy") chance += 0.05;
      if (helperId === "shy") chance += 0.02;
      if (jobId === "short") chance -= 0.05;

      if (chance < 0) chance = 0;
      if (chance > 0.5) chance = 0.5;
      return chance;
    }

    // ===== ä¼‘æ†©ã‚¤ãƒ™ãƒ³ãƒˆ =====
    const BREAK_EVENTS_BASE = {
      mother: {
        id: "mother",
        leaderLine: "ã€Œã‹ã‚ã•ã¾ãŒã€ãã£ã¨æ§˜å­ã‚’è¦‹ã«æ¥ã¦ãã‚ŒãŸã‚ˆã€‚ã¿ã‚“ãªã€ã¡ã‚ƒã‚“ã¨ä¼‘æ†©ã—ã¦ã‚‹ï¼Ÿã€",
        message: "ã‹ã‚ã•ã¾ãŒé™ã‹ã«éƒ¨å±‹ã‚’è¦‹å›ã‚Šã€ãƒŸãƒ‹ãŸã¡ã®é ­ã‚’ã½ã‚“ã½ã‚“ãªã§ã¦å›ã£ãŸã€‚",
        historyText: "ä¼‘æ†©ä¸­ã€ã‹ã‚ã•ã¾ãŒè¦‹å›ã‚Šã«æ¥ã¦ã€ãƒŸãƒ‹ãŸã¡ã®é ­ã‚’é †ç•ªã«ãªã§ã¦ã„ã£ãŸã€‚"
      },
      wanwan: {
        id: "wanwan",
        leaderLine: "ã€Œã‚ã‚“ã‚ã‚“ãŒéŠã³ã«æ¥ãŸã¿ãŸã„ã€‚ã‹ã‚ã•ã¾ã‚‚ã€å°‘ã—ç¬‘ã£ã¦ãã‚ŒãŸã‚‰å¬‰ã—ã„ãªã€‚ã€",
        message: "ã‚ã‚“ã‚ã‚“ãŒå°»å°¾ã‚’ã¶ã‚“ã¶ã‚“æŒ¯ã‚ŠãªãŒã‚‰é§†ã‘å›ã‚Šã€ãŠã¡ã³ãŸã¡ãŒéª¨ã‚’è¦‹ã›ã³ã‚‰ã‹ã—ã¦ã„ã‚‹ã€‚",
        historyText: "ä¼‘æ†©ä¸­ã€ã‚ã‚“ã‚ã‚“ãŒéŠã³ã«æ¥ã¦ã€ãƒŸãƒ‹ãŸã¡ã¨å°‘ã—ã ã‘ã˜ã‚ƒã‚Œåˆã£ãŸã€‚"
      },
      quiet: {
        id: "quiet",
        leaderLine: "ã€Œä»Šæ—¥ã¯é™ã‹ãªä¼‘æ†©ã ã­ã€‚ã‹ã‚ã•ã¾ã€æ·±å‘¼å¸ã—ã¦ã¿ã‚ˆã†ã€‚ã€",
        message: "ç‰¹åˆ¥ãªå‡ºæ¥äº‹ã¯ãªã„ã‘ã‚Œã©ã€é™ã‹ã§è½ã¡ç€ã„ãŸæ™‚é–“ãŒæµã‚Œã¦ã„ã‚‹ã€‚",
        historyText: "ä¼‘æ†©ä¸­ã€ç‰¹åˆ¥ãªå‡ºæ¥äº‹ã¯ãªã‹ã£ãŸãŒã€é™ã‹ã§ç©ã‚„ã‹ãªæ™‚é–“ãŒæµã‚ŒãŸã€‚"
      },
      wildMess: {
        id: "wildMess",
        leaderLine: "ã€Œã‚€ã¦ã£ã½ã†ãŠã¡ã³â€¦â€¦ä¼‘æ†©ä¸­ãã‚‰ã„ã¯é™ã‹ã«ã—ã¦ãã‚Œã‚‹ã¨åŠ©ã‹ã‚‹ã‚“ã ã‘ã©ã­ã€‚ã€",
        message: "ã‚€ã¦ã£ã½ã†ãŠã¡ã³ãŒã‚ã‚“ã‚ã‚“ã¨å…¨åŠ›ã§èµ°ã‚Šå›ã‚Šã€æœºã®ä¸Šã®ç´™ãŒä½•æšã‹èˆã„ä¸ŠãŒã£ãŸã€‚",
        historyText: "ä¼‘æ†©ä¸­ã€ã‚€ã¦ã£ã½ã†ãŠã¡ã³ãŒã¯ã—ã‚ƒãã™ãã¦ã€æ›¸é¡ãŒå°‘ã—æ•£ã‚‰ã°ã£ã¦ã—ã¾ã£ãŸã€‚"
      }
    };

    function pickBreakEvent(helper) {
      const pool = [];
      const add = (ev, w) => { for (let i = 0; i < w; i++) pool.push(ev); };

      add(BREAK_EVENTS_BASE.mother, 3);
      add(BREAK_EVENTS_BASE.wanwan, 2);
      add(BREAK_EVENTS_BASE.quiet, 3);
      if (helper.id === "wild") {
        add(BREAK_EVENTS_BASE.wildMess, 3);
      } else {
        add(BREAK_EVENTS_BASE.wildMess, 1);
      }

      if (pool.length === 0) return null;
      const index = Math.floor(Math.random() * pool.length);
      return pool[index];
    }

    // ===== ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆ & ãƒ†ãƒ¼ãƒå®šç¾© =====
    let researchPoints = 0;
    const researchUnlocks = new Set();

    const RESEARCH_TOPICS = {
      basic1: {
        id: "basic1",
        name: "å·¥æˆ¿åŸºç¤ç ”ç©¶ I",
        cost: 3,
        leaderLine: "ãŠã¡ã³ãŸã¡ã¨æ‰‹é †æ›¸ã‚’è¦‹ç›´ã—ã¦ã¿ãŸã‚ˆã€‚å°‘ã—ã ã‘ã€å¤±æ•—ãŒæ¸›ã‚‹ã¯ãšã€‚",
        miniLine: "ã‹ãŸã€ã‹ãŸã‹ãŸï¼ï¼ˆç´™ã‚’ãµã£ã¦ã„ã‚‹ï¼‰"
      },
      safety1: {
        id: "safety1",
        name: "å®‰å…¨ç®¡ç†ç ”ç©¶ I",
        cost: 3,
        leaderLine: "å®‰å…¨ã‚´ãƒ¼ã‚°ãƒ«ã¨æ‰‹è¢‹ã‚’å¢—ã‚„ã—ãŸã‚ˆã€‚ã“ã‚Œã§ã€å°çˆ†ç™ºã®å›æ•°ã¯æ¸›ã‚‹â€¦â€¦ã¯ãšã€‚",
        miniLine: "ã´ã´ã£ï¼ˆã‚´ãƒ¼ã‚°ãƒ«ã‚«ãƒã‚«ãƒï¼‰"
      },
      efficiency1: {
        id: "efficiency1",
        name: "å·¥æˆ¿åŠ¹ç‡ã‚¢ãƒƒãƒ— I",
        cost: 4,
        leaderLine: "ç´ æã®çµ„ã¿åˆã‚ã›ã‚’å¢—ã‚„ã—ã¦ã¿ãŸã‚ˆã€‚ã“ã‚Œã‹ã‚‰ã¯ã€è¦‹æ…£ã‚Œãªã„ã‚‚ã®ã‚‚å‡ºã¦ãã‚‹ã‹ã‚‚ã€‚",
        miniLine: "ã‹ãŸã‹ãŸâ€¦ï¼ï¼ˆãƒ¡ãƒ¢ã‚’æ›¸ãè¶³ã—ã¦ã„ã‚‹ï¼‰"
      },
      reckless1: {
        id: "reckless1",
        name: "ã‚€ã¦ã£ã½ã†æŒ™å‹•ç ”ç©¶ I",
        cost: 2,
        leaderLine: "â€¦â€¦ã‚€ã¦ã£ã½ã†ãŠã¡ã³ã®æ§˜å­ã‚’è¦³å¯Ÿã—ã¦ã¿ãŸã‚“ã ã‘ã©ã­ã€‚è‰¯ãã‚‚æ‚ªãã‚‚ã€ã•ã‚‰ã«æ¥µç«¯ã«ãªã£ãŸã‚ˆã€‚",
        miniLine: "ã´ãã‚ƒã£ï¼ï¼ˆæœºã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰"
      }
    };

    function applyResearchEffects(id) {
      if (id === "basic1") {
        Object.values(HELPERS).forEach(h => {
          h.successRate = Math.min(h.successRate + 0.05, 0.98);
        });
      } else if (id === "safety1") {
        Object.values(HELPERS).forEach(h => {
          h.explosionRate = Math.max(h.explosionRate - 0.04, 0);
        });
      } else if (id === "efficiency1") {
        if (!JOB_POOLS.standard.includes("wanwan_fur")) {
          JOB_POOLS.standard.push("wanwan_fur");
        }
        if (!JOB_POOLS.standard.includes("secret_fragment")) {
          JOB_POOLS.standard.push("secret_fragment");
        }
        if (!JOB_POOLS.focus.includes("wanwan_fur")) {
          JOB_POOLS.focus.push("wanwan_fur");
        }
        if (!JOB_POOLS.focus.includes("secret_fragment")) {
          JOB_POOLS.focus.push("secret_fragment");
        }
      } else if (id === "reckless1") {
        const wild = HELPERS.wild;
        if (wild) {
          wild.successRate = Math.min(wild.successRate + 0.05, 0.99);
          wild.explosionRate = Math.min(wild.explosionRate + 0.05, 0.7);
        }
      }
    }

    // ===== ã‚³ãƒ³ãƒ—ãƒªç”¨çŠ¶æ…‹ & å±¥æ­´ =====
    const discoveredItemIds = new Set();
    const historyLogs = []; // { timeStr, jobLabel, helperName, outcome, itemId, detail }

    const collectionListEl = document.getElementById("collectionList");
    const historyListEl = document.getElementById("historyList");
    const researchPointsStatusEl = document.getElementById("researchPointsStatus");
    const researchListEl = document.getElementById("researchList");

    // ===== æ°¸ç¶šåŒ– =====
    function saveData() {
      try {
        localStorage.setItem(
          STORAGE_KEYS.discoveredItems,
          JSON.stringify([...discoveredItemIds])
        );
        localStorage.setItem(
          STORAGE_KEYS.historyLogs,
          JSON.stringify(historyLogs)
        );
        localStorage.setItem(
          STORAGE_KEYS.researchPoints,
          String(researchPoints)
        );
        localStorage.setItem(
          STORAGE_KEYS.researchUnlocks,
          JSON.stringify([...researchUnlocks])
        );
      } catch (e) {
        console.warn("ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—:", e);
      }
    }

    function loadData() {
      try {
        const rawItems = localStorage.getItem(STORAGE_KEYS.discoveredItems);
        if (rawItems) {
          JSON.parse(rawItems).forEach(id => discoveredItemIds.add(id));
        }

        const rawHistory = localStorage.getItem(STORAGE_KEYS.historyLogs);
        if (rawHistory) {
          JSON.parse(rawHistory).forEach(entry => historyLogs.push(entry));
        }

        const rawRP = localStorage.getItem(STORAGE_KEYS.researchPoints);
        if (rawRP != null) {
          const n = Number(rawRP);
          if (!Number.isNaN(n)) researchPoints = n;
        }

        const rawUnlocks = localStorage.getItem(STORAGE_KEYS.researchUnlocks);
        if (rawUnlocks) {
          JSON.parse(rawUnlocks).forEach(id => researchUnlocks.add(id));
        }
      } catch (e) {
        console.warn("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
      }
    }

    function renderArchive() {
      const allItems = Object.values(ITEM_DEFS);
      if (allItems.length === 0) {
        collectionListEl.textContent = "ï¼ˆã¾ã ä½•ã‚‚ä½œã‚‰ã‚Œã¦ã„ãªã„ã‚ˆï¼‰";
      } else {
        const obtainedCount = allItems.filter(i => discoveredItemIds.has(i.id)).length;
        const totalCount = allItems.length;

        let html = `ã‚³ãƒ³ãƒ—ãƒªçŠ¶æ³ï¼š${obtainedCount} / ${totalCount} å€‹ å…¥æ‰‹æ¸ˆã¿<br><br>`;
        allItems.forEach(item => {
          const has = discoveredItemIds.has(item.id);
          html += `<div class="collection-item">` +
            `<span class="name">${item.name}</span>` +
            `<span class="state">[${has ? "å…¥æ‰‹æ¸ˆã¿" : "æœªå…¥æ‰‹"}]</span><br>` +
            `<span>${has ? item.desc : "ã¾ã å·¥æˆ¿ã§ã¯ä½œã‚‰ã‚Œã¦ã„ãªã„ã¿ãŸã„ã€‚"}</span>` +
            `</div>`;
        });
        collectionListEl.innerHTML = html;
      }

      if (historyLogs.length === 0) {
        historyListEl.textContent = "ï¼ˆã¾ã å±¥æ­´ã¯ãªã„ã‚ˆï¼‰";
      } else {
        const recent = historyLogs.slice(-40).reverse();
        let html = "";
        recent.forEach(log => {
          html += `<div class="history-entry">` +
            `[${log.timeStr}] ${log.jobLabel}ï¼ˆæ‹…å½“ï¼š${log.helperName}ï¼‰ â†’ ${log.detail}` +
            `</div>`;
        });
        historyListEl.innerHTML = html;
      }
    }

    function addHistoryEntry(jobLabel, helper, outcome, itemId, extraDetail) {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, "0");
      const m = String(now.getMinutes()).padStart(2, "0");
      const timeStr = `${h}:${m}`;

      let detail = "";

      if (extraDetail) {
        detail = extraDetail;
      } else if (outcome === "success" && itemId) {
        const item = ITEM_DEFS[itemId];
        detail = `æˆåŠŸï¼ã€${item.name}ã€ãŒå®Œæˆã—ãŸã€‚`;
      } else if (outcome === "fail") {
        detail = "ã†ã¾ãã„ã‹ãªã‹ã£ãŸâ€¦â€¦ææ–™ã ã‘ãŒé™ã‹ã«æ•£ã‚‰ã°ã£ã¦ã„ã‚‹ã€‚";
      } else if (outcome === "explosion" && itemId) {
        const item = ITEM_DEFS[itemId];
        detail = `å°çˆ†ç™ºï¼ ã—ã‹ã—ã€ç…™ãŒæ™´ã‚Œã‚‹ã¨ã€${item.name}ã€ã ã‘ãŒä¸æ€è­°ã«æ®‹ã£ã¦ã„ãŸã€‚`;
      } else if (outcome === "explosion") {
        detail = "å°çˆ†ç™ºï¼ éƒ¨å±‹ãŒã¡ã‚‡ã£ã¨ç„¦ã’ãã•ããªã£ãŸã€‚ã‚ã¨ã§ç‰‡ä»˜ã‘ã‚ˆã†ã€‚";
      } else if (outcome === "break") {
        detail = "ä¼‘æ†©ã‚¤ãƒ™ãƒ³ãƒˆã€‚";
      } else if (outcome === "research") {
        detail = extraDetail || "ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã®å¤‰å‹•ã€‚";
      } else {
        detail = "çµæœä¸æ˜ã€‚";
      }

      historyLogs.push({
        timeStr,
        jobLabel,
        helperName: helper.name,
        outcome,
        itemId: itemId || null,
        detail
      });

      saveData();
    }

    function updateResearchUI() {
      if (!researchPointsStatusEl || !researchListEl) return;

      researchPointsStatusEl.textContent = `ç¾åœ¨ã®ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆï¼š${researchPoints} RP`;

      const topics = Object.values(RESEARCH_TOPICS);
      if (topics.length === 0) {
        researchListEl.textContent = "ï¼ˆç ”ç©¶ãƒ†ãƒ¼ãƒãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚ˆï¼‰";
        return;
      }

      let html = "";
      topics.forEach(topic => {
        const unlocked = researchUnlocks.has(topic.id);
        let stateLabel;
        if (unlocked) {
          stateLabel = "ç ”ç©¶æ¸ˆã¿";
        } else if (researchPoints >= topic.cost) {
          stateLabel = "ç ”ç©¶å¯èƒ½";
        } else {
          stateLabel = "RPä¸è¶³";
        }

        const disabledAttr = (!unlocked && researchPoints >= topic.cost) ? "" : "disabled";

        html += `<div class="history-entry">` +
          `<div><span class="name">${topic.name}</span>ï¼ˆå¿…è¦RPï¼š${topic.cost}ï¼‰</div>` +
          `<div>çŠ¶æ…‹ï¼š${stateLabel}</div>` +
          `<div>ãƒªãƒ¼ãƒ€ãƒ¼ï¼šã€Œ${topic.leaderLine}ã€<br>ãŠã¡ã³ï¼šã€Œ${topic.miniLine}ã€</div>` +
          `<button class="btn sub research-btn" data-research-id="${topic.id}" ${disabledAttr}>` +
          `${unlocked ? "ç ”ç©¶æ¸ˆã¿" : "ç ”ç©¶ã™ã‚‹"}` +
          `</button>` +
          `</div>`;
      });

      researchListEl.innerHTML = html;
    }

    if (researchListEl) {
      researchListEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".research-btn");
        if (!btn) return;
        const id = btn.dataset.researchId;
        handleResearchClick(id);
      });
    }

    // ===== ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼‹ãŠã—ã”ã¨ï¼ä¼‘æ†©ç®¡ç† =====
    const leaderMessage = document.getElementById("leaderMessage");
    const jobStatus = document.getElementById("jobStatus");
    const helperStatus = document.getElementById("helperStatus");
    const timerStatus = document.getElementById("timerStatus");
    const phaseExtraStatus = document.getElementById("phaseExtraStatus");
    const cancelJobBtn = document.getElementById("cancelJobBtn");
    const jobButtons = document.querySelectorAll(".job-btn");

    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");

    const BREAK_SECONDS = 5 * 60;

    let phase = "idle"; // "idle" | "work" | "break"
    let currentJobLabel = null;
    let currentJobId = null;
    let remainingSeconds = 0;
    let totalSeconds = 0;
    let timerId = null;
    let isRunning = false;

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function updateUI() {
      if (!isRunning || phase === "idle") {
        jobStatus.textContent = "ä»Šã®ä½œæ¥­ï¼šãªã—";
        helperStatus.textContent = "ä»Šå›ã®æ‹…å½“ï¼šãªã—";
        timerStatus.textContent = "ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ä¸­ã€‚å·¥æˆ¿ã§ãŠã—ã”ã¨ã‚’é¸ã¶ã¨å§‹ã¾ã‚‹ã‚ˆã€‚";
        cancelJobBtn.disabled = true;

        if (progressBar && progressFill) {
          progressBar.style.display = "none";
          progressFill.style.width = "0%";
        }
        return;
      }

      const helper = currentHelperForJob || getCurrentHelper();

      if (phase === "work") {
        jobStatus.textContent = `ä»Šã®ä½œæ¥­ï¼š${currentJobLabel}`;
        helperStatus.textContent = `ä»Šå›ã®æ‹…å½“ï¼š${helper.name}`;
        timerStatus.textContent = `ãŠã—ã”ã¨ä¸­ï¼š${formatTime(remainingSeconds)}`;
        cancelJobBtn.disabled = false;
      } else if (phase === "break") {
        jobStatus.textContent = `ä»Šã®ä½œæ¥­ï¼š${currentJobLabel}ï¼ˆãŠã—ã”ã¨å®Œäº†ï¼‰`;
        helperStatus.textContent = `ä»Šå›ã®æ‹…å½“ï¼š${helper.name}`;
        timerStatus.textContent = `ä¼‘æ†©ä¸­ï¼š${formatTime(remainingSeconds)}`;
        cancelJobBtn.disabled = false;
      }
    }

    function resolveJobResult() {
      const helper = currentHelperForJob || getCurrentHelper();
      const jobId = currentJobId || "standard";
      const baseSuccess = helper.successRate;
      const baseExplosion = helper.explosionRate;

      const r = Math.random();
      let outcome;
      if (r < baseExplosion) {
        outcome = "explosion";
      } else if (r < baseExplosion + baseSuccess) {
        outcome = "success";
      } else {
        outcome = "fail";
      }

      let itemId = null;
      let rareFromExplosion = false;

      if (outcome === "success") {
        itemId = pickRandomItemIdForJob(jobId);
        if (itemId) {
          discoveredItemIds.add(itemId);
        }
      } else if (outcome === "explosion") {
        const rareChance = getExplosionRareChance(jobId, helper.id);
        if (Math.random() < rareChance) {
          const rareId = pickRandomRareItemId();
          if (rareId) {
            itemId = rareId;
            discoveredItemIds.add(rareId);
            rareFromExplosion = true;
          }
        }
      }

      let gainedRP = 0;
      if (outcome === "success") {
        gainedRP += 1;
        if (itemId && RARE_ITEM_IDS.includes(itemId)) {
          gainedRP += 1;
        }
      } else if (outcome === "explosion" && rareFromExplosion && itemId && RARE_ITEM_IDS.includes(itemId)) {
        gainedRP += 1;
      }
      if (gainedRP > 0) {
        researchPoints += gainedRP;
        addHistoryEntry(
          currentJobLabel + "ãƒ»ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆ",
          helper,
          "research",
          null,
          `ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã‚’ ${gainedRP} ç²å¾—ï¼ˆåˆè¨ˆï¼š${researchPoints} RPï¼‰ã€‚`
        );
        updateResearchUI();
      }

      if (outcome === "success" && itemId) {
        const item = ITEM_DEFS[itemId];
        leaderMessage.textContent =
          `ã€Œã‹ã‚ã•ã¾ã€ãŠã—ã”ã¨æˆåŠŸã ã‚ˆã€‚ã€${item.name}ã€ãŒã¡ã‚ƒã‚“ã¨å½¢ã«ãªã£ã¦ãã‚ŒãŸã€‚ã€`;
        phaseExtraStatus.textContent =
          `çµæœï¼šã€${item.name}ã€ãŒå®Œæˆã—ãŸã‚ˆã€‚ä¼‘æ†©ã—ãªãŒã‚‰ã€ã©ã†ä½¿ã†ã‹è€ƒãˆã‚ˆã£ã‹ã€‚`;
      } else if (outcome === "fail") {
        leaderMessage.textContent =
          "ã€Œâ€¦â€¦ä»Šå›ã¯ã†ã¾ãã„ã‹ãªã‹ã£ãŸã¿ãŸã„ã€‚æ¬¡ã¯ã€ã‚‚ã†å°‘ã—ã ã‘æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã‚ˆã†ã‹ã€‚ã€";
        phaseExtraStatus.textContent =
          "çµæœï¼šä»Šå›ã¯ä¸æˆåŠŸã€‚ã§ã‚‚ã€ã“ã®å¤±æ•—ã‚‚ãã£ã¨ç ”ç©¶ã®ææ–™ã«ãªã‚‹ã‚ˆã€‚";
      } else if (outcome === "explosion" && rareFromExplosion && itemId) {
        const item = ITEM_DEFS[itemId];
        leaderMessage.textContent =
          `ã€Œã‚ã£â€¦â€¦ï¼ å°çˆ†ç™ºã ã£ãŸã‘ã©ã€ã‹ã‚ã•ã¾è¦‹ã¦ã€‚ã€${item.name}ã€ãŒæ®‹ã£ã¦ãã‚ŒãŸã‚ˆã€‚ã€`;
        phaseExtraStatus.textContent =
          `çµæœï¼šå°çˆ†ç™ºã‹ã‚‰ã€${item.name}ã€ãŒç”Ÿã¾ã‚ŒãŸã‚ˆã€‚ã¡ã‚‡ã£ã¨å±ãªã‹ã£ãŸã‘ã©ã€ãƒ¬ã‚¢æˆæœï¼`;
      } else if (outcome === "explosion") {
        leaderMessage.textContent =
          "ã€Œã‚ã£â€¦â€¦ï¼ å°çˆ†ç™ºã ã€‚ã‹ã‚ã•ã¾ã€ã‚±ã‚¬ã¯ãªã„ï¼Ÿ ãŠç‰‡ä»˜ã‘ã¯ã¼ãã¨ãŠã¡ã³ãŸã¡ã«ä»»ã›ã¦ã€‚ã€";
        phaseExtraStatus.textContent =
          "çµæœï¼šå°çˆ†ç™ºã§æˆæœç‰©ã¯ãªã—ã€‚éƒ¨å±‹ãŒå°‘ã—ç„¦ã’ãã•ããªã£ãŸâ€¦â€¦ã‚ã¨ã§ç‰‡ä»˜ã‘ã‚ˆã†ã€‚";
      }

      addHistoryEntry(currentJobLabel, helper, outcome, itemId);
      saveData();
    }

    function startBreakPhase() {
      const helper = currentHelperForJob || getCurrentHelper();
      phase = "break";
      isRunning = true;
      remainingSeconds = BREAK_SECONDS;
      totalSeconds = BREAK_SECONDS;

      if (progressBar && progressFill) {
        progressBar.style.display = "block";
        progressFill.style.width = "0%";
      }

      const ev = pickBreakEvent(helper);
      if (ev) {
        phaseExtraStatus.textContent += `\n${ev.message}`;
        addHistoryEntry(currentJobLabel + "ãƒ»ä¼‘æ†©", helper, "break", null, ev.historyText);
      } else {
        phaseExtraStatus.textContent += "\nã€Œã‹ã‚ã•ã¾ã€å°‘ã—è‚©ã‚’å›ã—ãŸã‚Šã€ãŠæ°´ã®ã‚“ã ã‚Šã—ã‚ˆã€‚ã€";
      }

      updateUI();
      saveData();
    }

    function finishBreakPhase() {
      const helper = currentHelperForJob || getCurrentHelper();
      phase = "idle";
      isRunning = false;
      remainingSeconds = 0;
      totalSeconds = 0;

      if (progressBar && progressFill) {
        progressBar.style.display = "none";
        progressFill.style.width = "0%";
      }

      leaderMessage.textContent =
        "ã€Œã‹ã‚ã•ã¾ã€ä¼‘æ†©ãŠã¤ã‹ã‚Œã•ã¾ã€‚æ¬¡ã¯ã©ã‚“ãªãŠã—ã”ã¨ã«ã™ã‚‹ï¼Ÿã€";
      phaseExtraStatus.textContent = "";

      jobButtons.forEach(btn => {
        btn.disabled = false;
      });
      cancelJobBtn.disabled = true;
      currentHelperForJob = null;

      updateUI();
      renderArchive();
      saveData();
    }

    function tick() {
      if (!isRunning || phase === "idle") return;

      if (remainingSeconds > 0) {
        remainingSeconds -= 1;

        if (progressBar && progressFill && totalSeconds > 0) {
          const ratio = (totalSeconds - remainingSeconds) / totalSeconds;
          const clamped = Math.max(0, Math.min(1, ratio));
          progressFill.style.width = (clamped * 100) + "%";
        }

        updateUI();
        return;
      }

      clearInterval(timerId);
      timerId = null;

      if (phase === "work") {
        playBeepPattern();
        resolveJobResult();
        startBreakPhase();
        timerId = setInterval(tick, 1000);
      } else if (phase === "break") {
        playBeepPattern();
        finishBreakPhase();
      }
    }

    function startJob(jobId, minutes, label) {
      initAudioCtx();

      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }

      const helper = getCurrentHelper();
      currentHelperForJob = helper;

      currentJobId = jobId;
      currentJobLabel = label;
      remainingSeconds = Math.floor(minutes * 60);
      totalSeconds = remainingSeconds;
      phase = "work";
      isRunning = true;

      if (progressBar && progressFill) {
        progressBar.style.display = "block";
        progressFill.style.width = "0%";
      }

      leaderMessage.textContent = helper.startLine;
      jobStatus.textContent = `ä»Šã®ä½œæ¥­ï¼š${label}`;
      helperStatus.textContent = `ä»Šå›ã®æ‹…å½“ï¼š${helper.name}`;
      timerStatus.textContent = `ãŠã—ã”ã¨ä¸­ï¼š${formatTime(remainingSeconds)}`;
      phaseExtraStatus.textContent = "";

      factoryStatus.textContent =
        `ã€${label}ã€ã‚’ã€${helper.name}ã¨ä¸€ç·’ã«å§‹ã‚ãŸã‚ˆã€‚ãƒ›ãƒ¼ãƒ ã‹ã‚‰ã‚‚é€²æ—ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã€‚`;

      jobButtons.forEach(btn => {
        btn.disabled = true;
      });
      cancelJobBtn.disabled = false;

      timerId = setInterval(tick, 1000);
      updateUI();
      saveData();
    }

    function cancelJob() {
      if (!isRunning || phase === "idle") return;
      isRunning = false;
      phase = "idle";
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }

      if (progressBar && progressFill) {
        progressBar.style.display = "none";
        progressFill.style.width = "0%";
      }

      const helper = currentHelperForJob || getCurrentHelper();
      leaderMessage.textContent = "ã€Œâ€¦â€¦å¤§ä¸ˆå¤«ï¼Ÿç„¡ç†ã—ãªãã¦ã„ã„ã‚ˆã€ã‹ã‚ã•ã¾ã€‚ã€";
      jobStatus.textContent = `ä»Šã®ä½œæ¥­ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆ${currentJobLabel ?? "ä¸æ˜"}ï¼‰`;
      helperStatus.textContent = `æ‹…å½“ã—ã¦ã„ãŸãŠã¡ã³ï¼š${helper.name}`;
      timerStatus.textContent = "ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ä¸­ã€‚ã¾ãŸã‚„ã‚ŠãŸããªã£ãŸã‚‰å·¥æˆ¿ã‹ã‚‰é¸ã‚“ã§ã­ã€‚";
      phaseExtraStatus.textContent = "";

      jobButtons.forEach(btn => {
        btn.disabled = false;
      });
      cancelJobBtn.disabled = true;
      currentHelperForJob = null;

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚‚å±¥æ­´ã«æ®‹ã—ãŸã„å ´åˆã¯ã“ã“ã§è¿½è¨˜
      addHistoryEntry(
        currentJobLabel || "ä¸æ˜ãªãŠã—ã”ã¨",
        helper,
        "cancel",
        null,
        "ã‹ã‚ã•ã¾ã®åˆ¤æ–­ã§é€”ä¸­ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚ç„¡ç†ã—ãªã„ã®ã‚‚å¤§äº‹ã€‚"
      );
      saveData();
    }

    function handleResearchClick(id) {
      const topic = RESEARCH_TOPICS[id];
      if (!topic) return;
      if (researchUnlocks.has(id)) return;
      if (researchPoints < topic.cost) return;

      researchPoints -= topic.cost;
      researchUnlocks.add(id);
      applyResearchEffects(id);

      leaderMessage.textContent = `ã€Œ${topic.leaderLine}ã€`;
      phaseExtraStatus.textContent = `ãŠã¡ã³ï¼šã€Œ${topic.miniLine}ã€`;

      addHistoryEntry(
        `ç ”ç©¶ï¼šã€Œ${topic.name}ã€`,
        HELPERS.auto,
        "research",
        null,
        `ç ”ç©¶å®Œäº†ï¼š${topic.name}ï¼ˆRPæ¶ˆè²»ï¼š${topic.cost}ï¼‰`
      );

      updateResearchUI();
      saveData();
    }

    jobButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const minutes = Number(btn.dataset.minutes);
        const label = btn.dataset.label || "ãŠã—ã”ã¨";
        const jobId = btn.dataset.jobId || "standard";
        startJob(jobId, minutes, label);
      });
    });

    cancelJobBtn.addEventListener("click", cancelJob);

    // åˆæœŸè¡¨ç¤º
    (function init() {
      phase = "idle";
      isRunning = false;

      // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadData();

      jobStatus.textContent = "ä»Šã®ä½œæ¥­ï¼šãªã—";
      helperStatus.textContent = "ä»Šå›ã®æ‹…å½“ï¼šãªã—";
      timerStatus.textContent = "ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ä¸­ã€‚å·¥æˆ¿ã§ãŠã—ã”ã¨ã‚’é¸ã¶ã¨å§‹ã¾ã‚‹ã‚ˆã€‚";
      phaseExtraStatus.textContent = "";
      if (progressBar && progressFill) {
        progressBar.style.display = "none";
        progressFill.style.width = "0%";
      }
      renderArchive();
      updateResearchUI();
    })();
  </script>
</body>
</html>
